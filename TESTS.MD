# ðŸ“‘ Testes: RAG Multi-Figura v2.1

---

## ðŸŽ¯ MotivaÃ§Ã£o

O sistema v2.1 tinha todos os componentes implementados (Topic Router, Multi-Collection VectorStore, Hybrid Retriever, MemÃ³ria e Chain) mas sem validaÃ§Ã£o automatizada. A suite foi criada para prevenir regressÃµes, permitir testes rÃ¡pidos sem carregar o LLM e cobrir do componente isolado Ã  integraÃ§Ã£o total.

---

## ðŸ—ï¸ As 4 Camadas de Teste

### ðŸŸ¢ Camada 1: Topic Router
**17 testes | CPU apenas**

- DetecÃ§Ã£o de figuras (Galileu, Newton, Einstein) e queries comparativas
- Roteamento para categorias corretas (`biography`, `physics`, `astronomy`)
- Robustez: queries vazias, fallback e integridade do cache

### ðŸŸ¡ Camada 2: MemÃ³ria Conversacional
**9 testes | CPU apenas**

- AdiÃ§Ã£o de mensagens e limpeza de memÃ³ria
- PersistÃªncia de sessÃ£o via `save_load_estado`
- **Bug corrigido:** limite `k` sÃ³ era aplicado no `add_user_message`. Corrigido centralizando a lÃ³gica no mÃ©todo `_enforce_window()`

### ðŸŸ  Camada 3: Hybrid Retriever + VectorStore
**16 testes | ChromaDB ativo**

- Sanidade das collections (`renaissance`, `enlightenment`, `modern_era`)
- Isolamento: buscas sobre Einstein nÃ£o retornam documentos de Galileu
- Multi-collection: queries comparativas trazem resultados de mÃºltiplas fontes

### ðŸ”´ Camada 4: Chain E2E
**17 testes | LLM + VectorStore**

- DetecÃ§Ã£o de cumprimentos, continuidade de memÃ³ria com pronomes, estrutura do dicionÃ¡rio de saÃ­da
- **Status:** pendente â€” interrompido por timeout de download do modelo

---

## ðŸ› ï¸ DecisÃµes TÃ©cnicas

| Recurso | BenefÃ­cio |
| :--- | :--- |
| **Fixtures (Module Scope)** | VectorStore criado uma vez por sessÃ£o, evita reindexar o BM25 a cada teste |
| **`pytest.skip`** | Distingue erro de infraestrutura de erro de lÃ³gica |
| **`@pytest.mark.llm`** | Permite `pytest -m "not llm"` para execuÃ§Ã£o rÃ¡pida sem GPU |
| **Hook `pytest_terminal_summary`** | Visibilidade clara do status de prontidÃ£o do sistema |

---

## ðŸ“ˆ Resultado Final

- **Executados:** 42/42 (Camadas 1, 2 e 3)
- **Sucesso:** 100% apÃ³s correÃ§Ã£o do bug de memÃ³ria
- **PendÃªncia:** Camada 4 aguarda configuraÃ§Ã£o de ambiente

> **Dica:** O modelo Llama-3.2-3B Ã© o ideal para a RTX 3050 (4GB), garantindo que a Camada 4 rode sem estouro de VRAM.