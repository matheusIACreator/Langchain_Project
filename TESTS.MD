# ðŸ“‘ Resumo de Testes: RAG Multi-Figura v2.0

---

## ðŸŽ¯ Contexto e MotivaÃ§Ã£o
A anÃ¡lise do estado real do projeto revelou que, embora o sistema v2.0 tivesse todos os componentes implementados (**Topic Router, Multi-Collection VectorStore, Hybrid Retriever, MemÃ³ria e Chain**), nÃ£o existia uma validaÃ§Ã£o automatizada. 

A suite de testes foi criada para:
1. **Prevenir RegressÃµes:** Garantir que novos bugs nÃ£o cheguem a produÃ§Ã£o.
2. **Desenvolvimento Ãgil:** Permitir testes rÃ¡pidos sem a necessidade constante de carregar o LLM.
3. **ValidaÃ§Ã£o Progressiva:** Cobrir do componente isolado Ã  integraÃ§Ã£o total.

---

## ðŸ—ï¸ Arquitetura dos Testes: As 4 Camadas
A suite organiza-se em quatro camadas independentes com requisitos de infraestrutura distintos:

### ðŸŸ¢ Camada 1: Topic Router
* **MÃ©tricas:** 17 testes | **Requisitos:** CPU apenas (Sem GPU/LLM).
* **Foco:** O "cÃ©rebro" do roteamento.
    * **DetecÃ§Ã£o de Figuras:** Identifica nomes (Galileu, Newton, Einstein) e lida com queries comparativas.
    * **Roteamento de Experts:** Direciona perguntas para as categorias corretas (`biography`, `physics`, `astronomy`, `historical_context`).
    * **Robustez:** Tratamento de queries vazias, fallback para experts padrÃ£o e integridade do cache.

### ðŸŸ¡ Camada 2: MemÃ³ria Conversacional
* **MÃ©tricas:** 9 testes | **Requisitos:** CPU apenas.
* **Foco:** GestÃ£o de contexto e janela de histÃ³rico.
    * **OperaÃ§Ãµes Base:** AdiÃ§Ã£o de mensagens e limpeza de memÃ³ria.
    * **SerializaÃ§Ã£o:** Teste de `save_load_estado` para garantir persistÃªncia de sessÃ£o.
    * **Bug Corrigido:** O teste `test_window_respeita_limite_k` revelou que o limite $k$ sÃ³ era aplicado no `add_user_message`, deixando a resposta da IA extrapolar o limite. A lÃ³gica foi centralizada no mÃ©todo privado `_enforce_window()`.

### ðŸŸ  Camada 3: Hybrid Retriever + VectorStore
* **MÃ©tricas:** 16 testes | **Requisitos:** VectorStore (ChromaDB) ativo.
* **Foco:** IntegraÃ§Ã£o entre busca vetorial e busca por palavra-chave.
    1. **Sanidade:** Verifica se as collections (`renaissance`, `enlightenment`, `modern_era`) existem e contÃªm documentos.
    2. **Isolamento:** Garante que buscas sobre Einstein nÃ£o retornem documentos de Galileu (**RelevÃ¢ncia Negativa**).
    3. **Multi-collection:** Valida se buscas comparativas trazem resultados de mÃºltiplas fontes e respeitam o limite `k_final`.

### ðŸ”´ Camada 4: Chain E2E Completa
* **MÃ©tricas:** 17 testes | **Requisitos:** LLM + VectorStore.
* **Status:** *Pendente de execuÃ§Ã£o* (Interrompido por timeout de download do modelo).
* **Escopo:**
    * DetecÃ§Ã£o de cumprimentos (bypass de retrieval).
    * Continuidade de memÃ³ria com pronomes (ex: "Quem foi Newton?" -> "Onde **ele** nasceu?").
    * Estrutura completa do dicionÃ¡rio de saÃ­da da Chain.

---

## ðŸ› ï¸ DecisÃµes TÃ©cnicas de ImplementaÃ§Ã£o

| Recurso | DescriÃ§Ã£o | BenefÃ­cio |
| :--- | :--- | :--- |
| **Fixtures (Module Scope)** | VectorStore e Retriever criados uma Ãºnica vez por sessÃ£o. | Evita reindexar o BM25 16 vezes, economizando tempo. |
| **`pytest.skip`** | Salta testes se o VectorStore estiver vazio. | Distingue "erro de infraestrutura" de "erro de lÃ³gica". |
| **Marcador `@pytest.mark.llm`** | Permite rodar `pytest -m "not llm"`. | ExecuÃ§Ã£o ultra-rÃ¡pida (segundos) durante o coding. |
| **Hook Customizado** | `pytest_terminal_summary` formatado. | Visibilidade clara do status de prontidÃ£o do sistema. |

---

## ðŸ“ˆ Resultado Final da SessÃ£o

* **Testes Executados:** 42/42 (Camadas 1, 2 e 3).
* **Sucesso:** 100% (apÃ³s correÃ§Ã£o do bug de memÃ³ria).
* **Bug Detectado:** Erro na lÃ³gica de truncagem da janela de contexto (Corrigido).
* **PendÃªncia:** Camada 4 aguarda configuraÃ§Ã£o de ambiente.

> [!TIP]
> O modelo de **3B** (Llama-3.2) Ã© o ideal para a sua **RTX 3050 (4GB)**, garantindo que a Camada 4 rode sem estouro de VRAM ou timeouts excessivos.

---